---

title: Active Learning


keywords: fastai
sidebar: home_sidebar

summary: "Everything needed for Active Learning"
description: "Everything needed for Active Learning"
nb_path: "04_active_learning.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_active_learning.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Active-Learning-Data">Active Learning Data<a class="anchor-link" href="#Active-Learning-Data"> </a></h2><p>For active learning, we need to split the available training data between a training set and a pool set of (unlabelled) data, which we score using our model and acquisition function and add to the training set peu a peu.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="nn">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ActiveLearningData" class="doc_header"><code>class</code> <code>ActiveLearningData</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ActiveLearningData</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>)</p>
</blockquote>
<p>Splits <code>dataset</code> into an active dataset and an available dataset.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ActiveLearningData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Splits `dataset` into an active dataset and an available dataset.&quot;&quot;&quot;</span>

    <span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span>
    <span class="n">training_dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span>
    <span class="n">pool_dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span>
    <span class="n">training_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">pool_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),),</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_indices</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_dataset</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_dataset</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_dataset_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Transform indices (in `pool_dataset`) to indices in the original `dataset`.&quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_dataset</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">pool_indices</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">indices</span>

    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acquire elements from the pool dataset into the training dataset.</span>

<span class="sd">        Add them to training dataset &amp; remove them from the pool dataset.&quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset_indices</span><span class="p">(</span><span class="n">pool_indices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_indices</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_from_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_indices</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset_indices</span><span class="p">(</span><span class="n">pool_indices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pool_mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_indices</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_random_pool_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_dataset</span><span class="p">)</span>
        <span class="n">pool_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_dataset</span><span class="p">))[:</span><span class="n">size</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pool_indices</span>

    <span class="k">def</span> <span class="nf">extract_dataset_from_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extract a dataset randomly from the pool dataset and make those indices unavailable.</span>

<span class="sd">        Useful for extracting a validation set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_dataset_from_pool_from_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_random_pool_indices</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">extract_dataset_from_pool_from_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_indices</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extract a dataset from the pool dataset and make those indices unavailable.</span>

<span class="sd">        Useful for extracting a validation set.&quot;&quot;&quot;</span>
        <span class="n">dataset_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset_indices</span><span class="p">(</span><span class="n">pool_indices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_from_pool</span><span class="p">(</span><span class="n">pool_indices</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_indices</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ActiveLearningData.get_dataset_indices" class="doc_header"><code>ActiveLearningData.get_dataset_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L41" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ActiveLearningData.get_dataset_indices</code>(<strong><code>pool_indices</code></strong>:<code>List</code>[<code>int</code>])</p>
</blockquote>
<p>Transform indices (in <code>pool_dataset</code>) to indices in the original <code>dataset</code>.</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ActiveLearningData.acquire" class="doc_header"><code>ActiveLearningData.acquire</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L46" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ActiveLearningData.acquire</code>(<strong><code>pool_indices</code></strong>)</p>
</blockquote>
<p>Acquire elements from the pool dataset into the training dataset.</p>
<p>Add them to training dataset &amp; remove them from the pool dataset.</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ActiveLearningData.remove_from_pool" class="doc_header"><code>ActiveLearningData.remove_from_pool</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ActiveLearningData.remove_from_pool</code>(<strong><code>pool_indices</code></strong>)</p>
</blockquote>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ActiveLearningData.get_random_pool_indices" class="doc_header"><code>ActiveLearningData.get_random_pool_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L62" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ActiveLearningData.get_random_pool_indices</code>(<strong><code>size</code></strong>)</p>
</blockquote>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ActiveLearningData.extract_dataset_from_pool" class="doc_header"><code>ActiveLearningData.extract_dataset_from_pool</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L67" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ActiveLearningData.extract_dataset_from_pool</code>(<strong><code>size</code></strong>)</p>
</blockquote>
<p>Extract a dataset randomly from the pool dataset and make those indices unavailable.</p>
<p>Useful for extracting a validation set.</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ActiveLearningData.extract_dataset_from_pool_from_indices" class="doc_header"><code>ActiveLearningData.extract_dataset_from_pool_from_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L73" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ActiveLearningData.extract_dataset_from_pool_from_indices</code>(<strong><code>pool_indices</code></strong>)</p>
</blockquote>
<p>Extract a dataset from the pool dataset and make those indices unavailable.</p>
<p>Useful for extracting a validation set.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Additional-Helpers">Additional Helpers<a class="anchor-link" href="#Additional-Helpers"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_balanced_sample_indices" class="doc_header"><code>get_balanced_sample_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_balanced_sample_indices</code>(<strong><code>target_classes</code></strong>:<code>List</code>[<code>T</code>], <strong><code>num_classes</code></strong>, <strong><code>n_per_digit</code></strong>=<em><code>2</code></em>)</p>
</blockquote>
<p>Given <code>target_classes</code> randomly sample <code>n_per_digit</code> for each of the <code>num_classes</code> classes.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_subset_base_indices" class="doc_header"><code>get_subset_base_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L112" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_subset_base_indices</code>(<strong><code>dataset</code></strong>:<code>Subset</code>, <strong><code>indices</code></strong>:<code>List</code>[<code>int</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_base_indices" class="doc_header"><code>get_base_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L116" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_base_indices</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>indices</code></strong>:<code>List</code>[<code>int</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RandomFixedLengthSampler" class="doc_header"><code>class</code> <code>RandomFixedLengthSampler</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/active_learning.py#L122" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RandomFixedLengthSampler</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Sampler</code></p>
</blockquote>
<p>Sometimes, you really want to do more with little data without increasing the number of epochs.</p>
<p>This sampler takes a <code>dataset</code> and draws <code>target_length</code> samples from it (with repetition).</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_balanced_sample_indices</span><span class="p">(</span><span class="n">target_classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">n_per_digit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Given `target_classes` randomly sample `n_per_digit` for each of the `num_classes` classes.&quot;&quot;&quot;</span>
    <span class="n">permed_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_classes</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">n_per_digit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">num_samples_by_class</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">initial_samples</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">permed_indices</span><span class="p">)):</span>
        <span class="n">permed_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">permed_indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">permed_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_classes</span><span class="p">[</span><span class="n">permed_index</span><span class="p">])</span>

        <span class="n">num_target_samples</span> <span class="o">=</span> <span class="n">num_samples_by_class</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">num_target_samples</span> <span class="o">==</span> <span class="n">n_per_digit</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">initial_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">num_samples_by_class</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_samples</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_classes</span> <span class="o">*</span> <span class="n">n_per_digit</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">initial_samples</span>


<span class="k">def</span> <span class="nf">get_subset_base_indices</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_base_indices</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_base_indices</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">get_subset_base_indices</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">indices</span>


<span class="k">class</span> <span class="nc">RandomFixedLengthSampler</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Sampler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sometimes, you really want to do more with little data without increasing the number of epochs.</span>

<span class="sd">    This sampler takes a `dataset` and draws `target_length` samples from it (with repetition).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span>
    <span class="n">target_length</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">target_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_length</span> <span class="o">=</span> <span class="n">target_length</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure that we don&#39;t lose data by accident.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_length</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Sample slightly more indices to avoid biasing towards start of dataset.</span>
        <span class="c1"># Have the same number of duplicates for each sample.</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_length</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">target_length</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">iter</span><span class="p">((</span><span class="n">indices</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">target_length</span><span class="p">]</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_length</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

